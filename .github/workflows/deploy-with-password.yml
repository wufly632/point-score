name: Deploy with Password Authentication

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy using sshpass
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        # ÂÆâË£Ö sshpass
        sudo apt-get update
        sudo apt-get install -y sshpass
        
        # ‰ΩøÁî®ÂØÜÁ†Å SSH ËøûÊé•ÈÉ®ÁΩ≤
        sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            set -e
            echo "üöÄ Starting deployment..."
            
            # ÂàáÊç¢Âà∞È°πÁõÆÁõÆÂΩï
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Êõ¥Êñ∞‰ª£Á†Å
            git pull origin main
            
            # ÈáçÊñ∞ÈÉ®ÁΩ≤
            ./deploy.sh
            
            echo "‚úÖ Deployment completed!"
        EOF