name: Deploy with Password Authentication

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy using sshpass
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        # å®‰è£… sshpass
        sudo apt-get update
        sudo apt-get install -y sshpass
        
        # æ£€æŸ¥å¿…éœ€çš„çŽ¯å¢ƒå˜é‡
        if [ -z "$DEPLOY_HOST" ] || [ -z "$DEPLOY_USER" ] || [ -z "$DEPLOY_PASSWORD" ] || [ -z "$DEPLOY_PATH" ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€çš„éƒ¨ç½²çŽ¯å¢ƒå˜é‡"
          echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½®:"
          echo "- DEPLOY_HOST (æœåŠ¡å™¨åœ°å€)"
          echo "- DEPLOY_USER (SSH ç”¨æˆ·å)"
          echo "- DEPLOY_PASSWORD (SSH å¯†ç )"
          echo "- DEPLOY_PATH (éƒ¨ç½²è·¯å¾„)"
          exit 1
        fi
        
        echo "ðŸš€ å¼€å§‹è¿žæŽ¥æœåŠ¡å™¨: $DEPLOY_USER@$DEPLOY_HOST"
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        echo "ðŸš€ Starting deployment..."
        
        # åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
        if [ ! -d "$1" ]; then
          echo "âŒ éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨: $1"
          exit 1
        fi
        cd "$1"
        
        # æ›´æ–°ä»£ç 
        echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
        git pull origin main
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        echo "ðŸ”§ æ‰§è¡Œéƒ¨ç½²..."
        if [ -f "./deploy.sh" ]; then
          chmod +x ./deploy.sh
          ./deploy.sh
        else
          echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… Deployment completed!"
        SCRIPT_EOF
        
        # ä¸Šä¼ å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          deploy_script.sh "$DEPLOY_USER@$DEPLOY_HOST:/tmp/deploy_script.sh"
        
        sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "$DEPLOY_USER@$DEPLOY_HOST" "chmod +x /tmp/deploy_script.sh && /tmp/deploy_script.sh '$DEPLOY_PATH' && rm /tmp/deploy_script.sh"