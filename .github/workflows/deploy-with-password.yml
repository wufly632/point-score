name: Deploy with Password Authentication

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy using sshpass
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        # 安装 sshpass
        sudo apt-get update
        sudo apt-get install -y sshpass
        
        # 检查必需的环境变量
        if [ -z "$DEPLOY_HOST" ] || [ -z "$DEPLOY_USER" ] || [ -z "$DEPLOY_PASSWORD" ] || [ -z "$DEPLOY_PATH" ]; then
          echo "❌ 缺少必需的部署环境变量"
          echo "请在 GitHub Secrets 中设置:"
          echo "- DEPLOY_HOST (服务器地址)"
          echo "- DEPLOY_USER (SSH 用户名)"
          echo "- DEPLOY_PASSWORD (SSH 密码)"
          echo "- DEPLOY_PATH (部署路径)"
          exit 1
        fi
        
        echo "🚀 开始连接服务器: $DEPLOY_USER@$DEPLOY_HOST"
        
        # 创建部署脚本
        cat > deploy_script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        echo "🚀 Starting deployment..."
        
        # 切换到项目目录
        if [ ! -d "$1" ]; then
          echo "❌ 部署目录不存在: $1"
          exit 1
        fi
        cd "$1"
        
        # 更新代码
        echo "📥 拉取最新代码..."
        git pull origin main
        
        # 执行部署脚本
        echo "🔧 执行部署..."
        if [ -f "./deploy.sh" ]; then
          chmod +x ./deploy.sh
          ./deploy.sh
        else
          echo "❌ 部署脚本不存在"
          exit 1
        fi
        
        echo "✅ Deployment completed!"
        SCRIPT_EOF
        
        # 上传并执行部署脚本
        sshpass -p "$DEPLOY_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          deploy_script.sh "$DEPLOY_USER@$DEPLOY_HOST:/tmp/deploy_script.sh"
        
        sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          "$DEPLOY_USER@$DEPLOY_HOST" "chmod +x /tmp/deploy_script.sh && /tmp/deploy_script.sh '$DEPLOY_PATH' && rm /tmp/deploy_script.sh"